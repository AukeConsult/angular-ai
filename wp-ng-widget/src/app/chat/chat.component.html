<div class="app">
  <!-- Sidebar (ChatGPT-like left rail) -->
  <aside class="sidebar">
    <div class="brand">Chat</div>

    <button class="btn new-chat" (click)="newChat()">
      <span class="plus">＋</span>
      New chat
    </button>

    <div class="chat-list">
      <div
        class="chat-item"
        *ngFor="let c of conversationsSig(); trackBy: trackById"
        [class.active]="activeConv()?.id === c.id"
        (click)="selectChat(c.id)"
      >
        <div class="chat-title" title="{{ c.title || 'New chat' }}">
          {{ c.title || 'New chat' }}
        </div>
        <div class="chat-meta">
          {{ c.messages.length }} · {{ c.updatedAt | date:'short' }}
        </div>
        <div class="chat-actions" (click)="$event.stopPropagation()">
          <button class="icon" title="Rename" (click)="renameChat(c)">✏️</button>
          <button class="icon" title="Delete" (click)="deleteChat(c)">🗑️</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main panel -->
  <section class="main">
    <!-- Top bar -->
    <header class="topbar">
      <div class="title">{{ activeConv()?.title || 'New chat' }}</div>
      <div class="count">{{ activeMessageCount() }} messages</div>
      <div class="spacer"></div>
      <button *ngIf="activeConv()" class="btn ghost" (click)="clearChat(activeConv()!)">Clear</button>
    </header>

    <!-- Conversation -->
    <div #historyRef class="history">
      <ng-container *ngIf="activeConv() as conv">
        <div
          *ngFor="let m of conv.messages; trackBy: trackByIndex"
          class="msg"
          [class.me]="m.role==='user'"
          [class.ai]="m.role==='assistant'"
          [class.err]="m.role==='error'"
        >
          <div class="avatar" [class.user]="m.role==='user'"> {{ m.role==='user' ? 'U' : m.role==='assistant' ? 'A' : '!' }} </div>
          <div class="bubble">
            <div class="who">
              {{ m.role==='user' ? 'You' : m.role==='assistant' ? 'Assistant' : 'Error' }}
            </div>
            <ng-container *ngFor="let p of paragraphs(m.content)">
              <p class="text">{{ p }}</p>
            </ng-container>
          </div>
        </div>

        <div *ngIf="isSending" class="typing">Assistant is typing…</div>
      </ng-container>
    </div>

    <!-- Composer (sticky bottom, rounded input + send button) -->
    <footer class="composer">
      <div class="input-wrap">
        <textarea
          #inputRef
          class="input"
          [(ngModel)]="userMessage"
          name="message"
          rows="1"
          placeholder="Message ChatGPT"
          (keydown)="onComposerKeydown($event)"
          (input)="onTextareaInput()"
        ></textarea>

        <button
          class="send"
          type="button"
          [disabled]="isSending || !userMessage.trim()"
          (click)="send()"
          title="Send (Enter)"
        >
          <!-- paper plane icon (inline SVG) -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 11L21 3L13 21L11 13L3 11Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="hint">Press <kbd>Enter</kbd> to send • <kbd>Shift</kbd> + <kbd>Enter</kbd> for a new line</div>
    </footer>
  </section>
</div>
